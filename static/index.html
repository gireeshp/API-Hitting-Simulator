<!DOCTYPE html>
<html>
<head>
	<title>Simulator Demo</title>
</head>
<body>
	<div class="container" align="center">
		<h1 align="center">Simulator Control</h1>
		<div class="row">
			<form id="inputform">
				<table>
					<tr>
						<td>Total</td>
						<td><input type="text" id="total" name="total" placeholder="Enter total number of jobs" class="form-control"></td>
					</tr>
					<tr>
						<td>Parallel</td>
						<td><input type="text" id="parallel" name="parallel" placeholder="Enter number of jobs to run in parallel" class="form-control"></td>
					</tr>
				</table>
				<table>
					<tr>
						<td><button disabled class="btn btn-default" type="button" id="start-btn">Start</button></td>
						<td><button disabled class="btn btn-default" type="button" id="modify-btn">Modify</button></td>
						<td><button disabled class="btn btn-default" type="button" id="stop-btn">Stop</button></td>
					</tr>
				</table>
				<!-- <input type="text" name="msg" class="form-control"> -->
				<h4 align="center" id="message"></h4>
			</form>
		</div>
	</div>

	<div class="container" align="center">
		<table width="85%">
			<col width="95%">
  			<col width="5">
  			<tr>
  				<td></td>
  				<td><button class="btn btn-default" type="button" id="refresh-btn">Refresh</button></td>
  			</tr>
  		</table>
  		<table width="85%">
			<tr>
				<td>
					<iframe id="dashboard" src="http://127.0.0.1:51304/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/#/overview?namespace=default" height="700" width="100%"></iframe>
				</td>
			</tr>
		</table>
	</div>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script type="text/javascript">

		$(document).ready(function(){
	
			var baseUrl = "http://127.0.0.1:5000/";

			function start() {

				console.log("Inside start")

				if (!validateInput()) {
					return
				}

				var total=$("#inputform").find("input[name=total]").val();
				var parallel=$("#inputform").find("input[name=parallel]").val();

				var startUrl = buildUrl(baseUrl+"start", "total", encodeURIComponent(total));
				startUrl = buildUrl(startUrl, "parallel", encodeURIComponent(parallel));

				console.log("Total: "+total+". Parallel: "+parallel+". URL: "+startUrl);

				$.get(startUrl, function(output) {
					if(!output) return;
				}, "json");

				status();
				alert ("Started the Simulator")
			}

			function modify() {

				if (!validateInput()) {
					return
				}

				var total=$("#inputform").find("input[name=total]").val();
				var parallel=$("#inputform").find("input[name=parallel]").val();

				var modifyUrl = buildUrl(baseUrl+"modify", "total", encodeURIComponent(total));
				modifyUrl = buildUrl(modifyUrl, "parallel", encodeURIComponent(parallel));

				console.log("Total: "+total+". Parallel: "+parallel+". URL: "+modifyUrl);

				$.get(modifyUrl, function(output) {
					if(!output) return;
				}, "json");

				status();
				alert ("Modified the Simulator configurations")
			}

			function stop() {

				var stopUrl = baseUrl+"stop";

				console.log("URL: "+stopUrl);

				$.get(stopUrl, function(output) {
					if(!output) return;
				}, "json");

				status();
				alert ("Stopped the Simulator")
			}

			function validateInput() {

				console.log("Inside validateInput: "+$("#inputform").find("input[name=total]").val())

				if (!$("#inputform").find("input[name=total]").val()) {
					$("#inputform").find("input[name=total]").focus()
					alert ("Please provide number of 'Total' & 'Parallel' threads required")
					return false
				}

				if (!$("#inputform").find("input[name=parallel]").val()) {
					$("#inputform").find("input[name=parallel]").focus()
					alert ("Please provide number of 'Total' & 'Parallel' threads required")
					return false
				}

				return true;
			}

			function status() {

				var stopUrl = baseUrl+"status";

				$.get(stopUrl, function(output) {
					if(!output) return;

					if (output.running) {
						$("#start-btn").attr("disabled", true)
						$("#modify-btn").attr("disabled", false)
						$("#stop-btn").attr("disabled", false)

						if (!$("#inputform").find("input[name=total]").val()) {
							$("#inputform").find("input[name=total]").val(output.total);
							$("#inputform").find("input[name=parallel]").val(output.parallel);
						}

					} else {
						$("#start-btn").attr("disabled", false)
						$("#modify-btn").attr("disabled", true)
						$("#stop-btn").attr("disabled", true)
					}

					$("#message").text(output.message);
				}, "json");
			}

			function buildUrl(base, key, value) {
				var sep = (base.indexOf('?') > -1) ? '&':'?';
				return base + sep + key + "=" + value;
			}

			// Restricts input for the given textbox to the given inputFilter.
			function setInputFilter(textbox, inputFilter) {
			  ["input", "keydown", "keyup", "mousedown", "mouseup", "select", "contextmenu", "drop"].forEach(function(event) {
			    textbox.oldValue = "";
			    textbox.addEventListener(event, function() {
			      if (inputFilter(this.value)) {
			        this.oldValue = this.value;
			        this.oldSelectionStart = this.selectionStart;
			        this.oldSelectionEnd = this.selectionEnd;
			      } else if (this.hasOwnProperty("oldValue")) {
			        this.value = this.oldValue;
			        this.setSelectionRange(this.oldSelectionStart, this.oldSelectionEnd);
			      }
			    });
			  });
			}

			function refreshFrame() {
				iFrame = document.getElementById("dashboard");
				iFrame.src = iFrame.src;
			}

			// Restrict input to digits and '.' by using a regular expression filter.
			setInputFilter(document.getElementById("total"), function(value) {
			  return /^\d*$/.test(value);
			});
			setInputFilter(document.getElementById("parallel"), function(value) {
			  return /^\d*$/.test(value);
			});

			// Assign functions to buttons.
			$("#start-btn").click(start);
			$("#modify-btn").click(modify);
			$("#stop-btn").click(stop);
			$("#refresh-btn").click(refreshFrame);


			// Call status once on page load
			status();

			// Refresh the status every 5 seconds
			myStatus = setInterval(status, 5000);
		});
	</script>

</body>
</html>